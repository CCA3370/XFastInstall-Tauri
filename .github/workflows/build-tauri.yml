name: Build Tauri (Windows Portable)

on:
  push:
    branches: [dev]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_NET_RETRY: 3

jobs:
  build-windows-portable:
    name: Windows (Portable EXE)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Check if fast build
        id: check_fast
        shell: bash
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"dbuild"* ]]; then
            echo "is_fast=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Fast build mode enabled (optimized for speed)"
          else
            echo "is_fast=false" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Standard build mode (optimized for size)"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install JS dependencies
        run: npm ci

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies (Fast mode)
        if: steps.check_fast.outputs.is_fast == 'true'
        uses: Swatinem/rust-cache@v2
        with:
          # Use a stable prefix key for fast builds
          prefix-key: "v2-rust-fast"
          # Include build settings in cache key to avoid conflicts
          key: "fast-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}"
          # Always save cache, even on failure
          cache-on-failure: true
          save-if: true
          # Cache all target directories
          cache-all-crates: true
          # Cache directories
          cache-directories: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/

      - name: Cache Rust dependencies (Standard mode)
        if: steps.check_fast.outputs.is_fast == 'false'
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v2-rust-standard"
          key: "standard-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}"
          cache-on-failure: false
          cache-all-crates: true
          cache-directories: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/

      - name: Set fast build environment
        if: steps.check_fast.outputs.is_fast == 'true'
        shell: bash
        run: |
          # Enable incremental compilation for faster rebuilds
          echo "CARGO_INCREMENTAL=1" >> $GITHUB_ENV
          # Use maximum codegen units for maximum parallelism
          echo "CARGO_PROFILE_RELEASE_CODEGEN_UNITS=256" >> $GITHUB_ENV
          # Disable LTO completely for fastest linking
          echo "CARGO_PROFILE_RELEASE_LTO=off" >> $GITHUB_ENV
          # Use minimal optimization for fastest compilation
          echo "CARGO_PROFILE_RELEASE_OPT_LEVEL=1" >> $GITHUB_ENV
          # Keep debug info minimal
          echo "CARGO_PROFILE_RELEASE_DEBUG=0" >> $GITHUB_ENV
          # Still strip symbols to reduce size
          echo "CARGO_PROFILE_RELEASE_STRIP=symbols" >> $GITHUB_ENV
          # Keep panic=abort
          echo "CARGO_PROFILE_RELEASE_PANIC=abort" >> $GITHUB_ENV
          # Additional speed optimizations (removed -C prefer-dynamic as it conflicts with panic=abort)
          echo "RUSTFLAGS=-C embed-bitcode=no" >> $GITHUB_ENV
          # Use faster linker if available
          echo "CARGO_PROFILE_RELEASE_SPLIT_DEBUGINFO=unpacked" >> $GITHUB_ENV
          echo "BUILD_MODE=fast" >> $GITHUB_ENV
          echo "âœ… Fast build environment configured (MAXIMUM SPEED)"
          echo "ðŸ“Š Incremental: ON, Codegen: 256, LTO: OFF, Opt: 1"

      - name: Check cache status (Fast mode)
        if: steps.check_fast.outputs.is_fast == 'true'
        shell: bash
        run: |
          echo "ðŸ” Checking cache status..."
          if [ -d "target/release/incremental" ]; then
            echo "âœ… Incremental cache found!"
            ls -lh target/release/incremental/ | head -10
          else
            echo "âš ï¸ No incremental cache found (first build)"
          fi
          if [ -d "target/release/build" ]; then
            echo "âœ… Build cache found!"
            echo "ðŸ“¦ Cached crates: $(ls target/release/build | wc -l)"
          else
            echo "âš ï¸ No build cache found"
          fi

      - name: Set standard build environment
        if: steps.check_fast.outputs.is_fast == 'false'
        shell: bash
        run: |
          # Disable incremental for smaller artifacts and reproducibility
          echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV
          # Single codegen unit for maximum optimization
          echo "CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1" >> $GITHUB_ENV
          # Fat LTO for maximum runtime performance
          echo "CARGO_PROFILE_RELEASE_LTO=fat" >> $GITHUB_ENV
          # Maximum optimization for best runtime performance
          echo "CARGO_PROFILE_RELEASE_OPT_LEVEL=3" >> $GITHUB_ENV
          # Strip symbols
          echo "CARGO_PROFILE_RELEASE_STRIP=symbols" >> $GITHUB_ENV
          # Panic abort for smaller binary
          echo "CARGO_PROFILE_RELEASE_PANIC=abort" >> $GITHUB_ENV
          # Additional optimizations for maximum performance
          echo "RUSTFLAGS=-C target-cpu=x86-64-v2" >> $GITHUB_ENV
          echo "BUILD_MODE=standard" >> $GITHUB_ENV

      - name: Build Tauri (Fast)
        if: steps.check_fast.outputs.is_fast == 'true'
        run: |
          echo "ðŸš€ Building in FAST mode (incremental + thin LTO + parallel codegen)..."
          npm run tauri:build

      - name: Show build statistics (Fast mode)
        if: steps.check_fast.outputs.is_fast == 'true'
        shell: bash
        run: |
          echo "ðŸ“Š Build completed! Statistics:"
          if [ -d "target/release/incremental" ]; then
            echo "âœ… Incremental cache size: $(du -sh target/release/incremental | cut -f1)"
          fi
          if [ -d "target/release/build" ]; then
            echo "âœ… Build artifacts: $(ls target/release/build | wc -l) crates"
          fi
          if [ -f "target/release/xfastmanager.exe" ]; then
            echo "âœ… Binary size: $(du -h target/release/xfastmanager.exe | cut -f1)"
          fi

      - name: Build Tauri (Standard)
        if: steps.check_fast.outputs.is_fast == 'false'
        run: |
          echo "ðŸ“¦ Building in STANDARD mode (fat LTO + single codegen unit)..."
          npm run tauri:build

      - name: Rename EXE
        run: Rename-Item -Path "target/release/xfastmanager.exe" -NewName "XFast-Manager.exe" -Force

      - name: Upload Fast Build
        if: steps.check_fast.outputs.is_fast == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: XFast-Manager-windows-fast
          path: 'target/release/XFast-Manager.exe'
          if-no-files-found: error
          retention-days: 7

      - name: Upload Standard Build
        if: steps.check_fast.outputs.is_fast == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: XFast-Manager-windows-portable
          path: 'target/release/XFast-Manager.exe'
          if-no-files-found: error


